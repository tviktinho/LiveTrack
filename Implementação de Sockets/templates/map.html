<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapa de Usuários</title>

    <!-- Estilos -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    />

    <link rel="manifest" href="/manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nats.ws@1.9.0/nats.js"></script>

    <style>
      #map {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        z-index: 0;
      }
      body {
        font-family: Arial, sans-serif;
        text-align: center;
      }
    </style>
  </head>

  <body>
    <div id="login-container">
      <input type="text" id="username" placeholder="Digite seu nome" />
      <button onclick="saveUsername()">Entrar</button>
    </div>

    <div id="map"></div>
    <h2>Mapa dos Usuários</h2>

    <div
      id="client-list-container"
      class="card position-absolute"
      style="top: 0; right: 0; width: 300px; height: 40px"
    >
      <button onclick="updateClientList()" class="btn btn-primary">
        Atualizar Lista de Clientes
      </button>

      <button onclick="updateMap(currentData)" class="btn btn-primary">
        Atualizar Mapa
      </button>

      <ul id="client-list" class="list-group"></ul>

      <button id="markPointButton" class="btn btn-success">Marcar Ponto</button>

      <button onclick="disconnectUser()" class="btn btn-danger">
        Desconectar
      </button>
    </div>

    <script type="module">
      import { connect } from "https://cdn.skypack.dev/nats.ws@1.9.0";

      let map = L.map("map").setView([-14.235, -51.9253], 4);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      let markers = {};
      let currentData = {};
      let nc = undefined; // NATS connection

      async function connectNATS() {
        try {
          if (!nc) {
            nc = await connect({ servers: "ws://35.238.213.13:9222" });
            console.log("[NATS] Conectado com sucesso!");
      
            const sub = nc.subscribe("locations");
            (async () => {
              for await (const msg of sub) {
                const decoded = new TextDecoder().decode(msg.data);
                const data = JSON.parse(decoded);
              
                currentData[data.username] = { lat: data.lat, lon: data.lon };
                updateMap(currentData); // <- sempre atualiza o mapa inteiro
                updateClientList();

                console.log("[NATS] Mensagem recebida:", data);
                console.log("[DEBUG] Atualizando mapa com:", currentData);
              }
            })();
          }
        } catch (error) {
          console.error("[NATS] Erro ao conectar:", error);
          nc = undefined;
        }
      }
      

      function updateMarker(username, lat, lon) {
        if (!markers[username]) {
          markers[username] = L.marker([lat, lon])
            .addTo(map)
            .bindPopup(`Usuário: ${username}`);
        } else {
          markers[username]
            .setLatLng([lat, lon])
            .bindPopup(`Usuário: ${username}`);
        }
      }

      function updateClientList() {
        const clientList = document.getElementById("client-list");
        clientList.innerHTML = ""; // limpa a lista
      
        const seen = new Set();
      
        Object.keys(markers).forEach((client) => {
          if (seen.has(client)) return;
          seen.add(client);
      
          const li = document.createElement("li");
          li.className = "list-group-item";
          li.textContent = client;
          li.onclick = () => zoomToClient(client);
          clientList.appendChild(li);
        });
      }
      

      function zoomToClient(clientId) {
        if (markers[clientId]) {
          map.setView(markers[clientId].getLatLng(), 10);
        }
      }

      function updateMap(data) {
        console.log("[DEBUG] Atualizando mapa com:", data);
        for (const [client, info] of Object.entries(data)) {
          if (!markers[client]) {
            markers[client] = L.marker([info.lat, info.lon])
              .addTo(map)
              .bindPopup(`Usuário: ${client}`);
          } else {
            const current = markers[client].getLatLng();
            if (current.lat !== info.lat || current.lng !== info.lon) {
              markers[client].setLatLng([info.lat, info.lon]);
            }
          }
        }
      }
      

      function disconnectUser() {
        if (nc) {
          nc.close();
          console.log("[NATS] Desconectado manualmente.");
          alert("Você se desconectou do servidor.");
        }
      }

      function saveUsername() {
        const input = document.getElementById("username");
        if (input && input.value.trim() !== "") {
          const name = input.value.trim();
          localStorage.setItem("username", name);
          document.getElementById("login-container").style.display = "none";
          console.log(`[LOGIN] Usuário setado: ${name}`);
        } else {
          alert("Por favor, insira um nome.");
        }
      }

      // Expor funções globais
      window.updateClientList = updateClientList;
      window.zoomToClient = zoomToClient;
      window.updateMap = updateMap;
      window.disconnectUser = disconnectUser;
      window.saveUsername = saveUsername;

      // Iniciar conexão NATS ao carregar a página
      window.onload = connectNATS;
    </script>
  </body>
</html>
