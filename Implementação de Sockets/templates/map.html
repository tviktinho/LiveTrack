<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapa de Usuários</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    />
    <link rel="manifest" href="/manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
      #map {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        z-index: 0;
      }
      body {
        font-family: Arial, sans-serif;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <h2>Mapa dos Usuários</h2>

    <div
      id="client-list-container"
      class="card position-absolute"
      style="top: 0; right: 0; width: 300px; height: 40px"
    >
      <button onclick="updateClientList()" class="btn btn-primary">
        Atualizar Lista de Clientes
      </button>

      <ul id="client-list" class="list-group" onclick="zoomToClient()"></ul>
      <button id="markPointButton" class="btn btn-success">Marcar Ponto</button>
    </div>

    <script>
      let map;
      let markers = {};
      let socket;

      function initMap() {
        map = L.map("map").setView([-14.235, -51.9253], 4);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);
      }

      function updateMarkers(data) {
        for (const [client, info] of Object.entries(data)) {
          if (
            typeof info.lat !== "number" ||
            typeof info.lon !== "number" ||
            isNaN(info.lat) ||
            isNaN(info.lon)
          ) {
            console.warn(
              `Coordenadas inválidas recebidas para ${client}:`,
              info
            );
            continue;
          }

          if (markers[client]) {
            markers[client].setLatLng([info.lat, info.lon]);
          } else {
            markers[client] = L.circleMarker([info.lat, info.lon], {
              color: info.color || "blue",
              radius: 8,
              fillColor: info.color || "blue",
              fillOpacity: 0.8,
            })
              .addTo(map)
              .bindPopup(`Usuário: ${client}`);
          }
        }

        console.log("[DEBUG] Atualização de marcador para:", Object.keys(data));
      }

      function zoomToClient(clientId) {
        console.log("Buscando cliente:", clientId);
        console.log("Clientes disponíveis:", Object.keys(markers));

        const clientMarker = markers[clientId];
        if (clientMarker) {
          const latLng = clientMarker.getLatLng();
          if (!latLng) {
            console.error("Não foi possível obter coordenadas para", clientId);
            return;
          }
          map.setView([latLng.lat, latLng.lng], 10);
        } else {
          console.error("Cliente não encontrado:", clientId);
        }
      }

      function updateMap(data) {
        const clientList = document.getElementById("client-list");
        clientList.innerHTML = "";
        let cont = 0;

        for (const clientId in markers) {
          if (!data[clientId]) {
            markers[clientId].remove();
            delete markers[clientId];
          }
        }

        for (const [client, { lat, lon, color }] of Object.entries(data)) {
          if (markers[client]) {
            markers[client].setLatLng([lat, lon]);
          } else {
            markers[client] = L.circleMarker([lat, lon], {
              color: color,
              radius: 8,
              fillColor: color,
              fillOpacity: 0.8,
            })
              .addTo(map)
              .bindPopup(`Usuário: ${client}`);
          }
          let listItem = document.createElement("li");
          listItem.className = "list-group-item";
          listItem.textContent = `Cliente ${cont} ${client}`;
          listItem.onclick = () => zoomToClient(client); // Correção: Passa client correto
          clientList.appendChild(listItem);
          cont += 1;
        }
      }

      function updateClientList() {
        let clientList = document.getElementById("client-list");
        var cont = 0;
        clientList.innerHTML = "";
        for (const client in markers) {
          let li = document.createElement("li");
          li.className = "list-group-item";
          li.textContent = `Cliente  ${cont} ${client}`;
          cont += 1;
          clientList.appendChild(li);
        }
      }

      function fetchData() {
        fetch("/data")
          .then((response) => response.json())
          .then((data) => updateMap(data))
          .catch((error) => console.error("Erro ao obter dados:", error));
      }

      function mark_point_on_map(lat, lon) {
        if (typeof lat === "number" && typeof lon === "number") {
          L.marker([lat, lon])
            .addTo(map)
            .bindPopup(`Ponto marcado: ${lat}, ${lon}`)
            .openPopup();
        } else {
          console.error("Coordenadas inválidas:", lat, lon);
        }
      }

      function startWebSocket() {
        let socket = new WebSocket("ws://localhost:6790");

        socket.onopen = () => console.log("Conexão WebSocket estabelecida.");

        socket.onmessage = (event) => {
          try {
            let data = JSON.parse(event.data);
            console.log("[DADOS RECEBIDOS]", data);
            if (data.type === "location_update") {
              let clientData = {
                [data.client_id]: {
                  lat: data.lat,
                  lon: data.lon,
                  color: data.color || "blue",
                },
              };
              updateMap(clientData);
            } else {
              updateMap(data);
            }
          } catch (error) {
            console.error("Erro ao processar mensagem WebSocket:", error);
          }
        };

        socket.onerror = (error) => console.error("WebSocket error:", error);

        socket.onclose = () => {
          console.log("Conexão WebSocket fechada. Tentando reconectar...");
          setTimeout(startWebSocket, 5000);
        };
      }

      function reconnect() {
        if (socket) {
          socket.close();
        }
        startWebSocket();
      }

      window.onload = function () {
        initMap();
        fetchData();
        document
          .getElementById("markPointButton")
          .addEventListener("click", () => {
            map.once("click", function (e) {
              const lat = e.latlng.lat;
              const lon = e.latlng.lng;
              mark_point_on_map(lat, lon);
              fetch("/mark_point", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ lat, lon }),
              });
            });
            map.getContainer().style.cursor = "crosshair"; // Change cursor to crosshair
          });

        map.on("click", function () {
          map.getContainer().style.cursor = ""; // Reset cursor back to default
        });

        startWebSocket();
      };
      
    </script>
  </body>
</html>
