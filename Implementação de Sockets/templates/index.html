<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveTrack - Mapa</title>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #map { height: 500px; width: 90%; margin: auto; }
    </style>
</head>
<body>
    <h1>LiveTrack</h1>
    <button onclick="updateLocations()">Atualizar Localização</button>
    <button onclick="reconnect()">Reconectar</button>
    <button onclick="exitApp()">Sair</button>
    <button onclick="sendLocation()">Compartilhar Localização</button>
    <div id="map"></div>


    <script>
        let map = L.map('map').setView([-23.5505, -46.6333], 12); // São Paulo como posição inicial
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        async function updateLocations() {
            let response = await fetch('/locations');
            let locations = await response.json();
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            locations.forEach(loc => {
                L.marker([loc.lat, loc.lon]).addTo(map).bindPopup(loc.name).openPopup();
            });
        }

        function reconnect() {
            location.reload();
        }

        function exitApp() {
            fetch('/shutdown'); // Encerra o Flask
            window.close(); // Fecha a janela do Electron
        }

        async function sendLocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    let data = {
                        name: "Usuário", // Aqui futuramente pode ser o nome do usuário real
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
    
                    let response = await fetch('/update_location', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
    
                    if (response.ok) {
                        alert("Localização enviada!");
                        updateLocations(); // Atualiza o mapa
                    } else {
                        alert("Erro ao enviar localização.");
                    }
                }, () => {
                    alert("Erro ao acessar GPS.");
                });
            } else {
                alert("Geolocalização não suportada pelo navegador.");
            }
        }

    </script>
</body>
</html>
